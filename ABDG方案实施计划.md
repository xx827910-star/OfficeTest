# ABDG方案实施计划

## 目标
改进AI代码生成流程，引导AI优先使用best_practices中的参考代码，而不是自己重写。

## 核心方案组合
- **方案A**: 决策树流程（在generate_formatter_code.md中增加）
- **方案B**: 反思检查点（在执行流程各阶段增加）
- **方案D**: 快速索引（在文档开头增加）
- **方案G**: 快速查找工具code_finder.py（核心工具）

---

## 实施细节确认

### 1. code_finder.py 功能设计
- ❌ 不实现自动提取功能（--extract）
- ✅ 提供精确的文件名+行号，让AI自己用Read工具读取
- ✅ 简化版依赖树：只标记直接依赖（一级）
- ✅ 输出格式：文件名 + 方法名 + 说明（简洁版）

### 2. FEATURE_DATABASE 覆盖范围
**第一阶段（核心功能）**：
1. 目录系统（可点击+PAGEREF）
2. 图表编号（SEQ字段）
3. 公式系统（OMML）
4. 参考文献（交叉引用）
5. 字体处理（中英文分离）

**后续扩展**：
- 三线表（边框控制）
- 页码分节
- 其他边界情况处理

**行号精度**：精确到每个方法的起止行号

### 3. 提示词修改方式
- ✅ 在现有 generate_formatter_code.md 基础上插入新内容
- ❌ 不重构整个文档结构
- ✅ 保持与现有阶段1、阶段2的兼容性

### 4. 强制程度
- ✅ 强制要求：在决策树中设为"必须步骤"
- ✅ 在反思检查点中强制回答"是否运行了工具"
- ✅ 使用明确的标记：⚠️ 强制步骤

### 5. 输出格式
简化版输出（不过度详细）：
```
文件: xxx_reference.py
方法: method_name (行XX-YY) [复用度]
说明: 简短功能描述
依赖: 依赖的其他方法（如果有）
```

### 6. 实施优先级
**分步实施，逐步验证**

---

## 实施步骤

### 第一阶段：核心工具和快速索引

**Step 1: 创建 code_finder.py**
- 定位：`best_practices/code_finder.py`
- 功能：
  - 搜索功能（关键词匹配）
  - 列出所有功能（--list）
  - 详细查询（显示方法、行号、依赖）
- 数据库内容：5个核心功能模块
  - 目录系统
  - 图表编号
  - 公式系统
  - 参考文献
  - 字体处理

**Step 2: 修改 generate_formatter_code.md - 添加快速索引（方案D）**
- 位置：文档开头，"概述"之前
- 内容：
  - 工具使用指南（如何运行code_finder.py）
  - 常用查询示例
  - 工具的价值说明
  - ⚠️ 标记：实现功能前必须先运行工具

**Step 3: 验证工具功能**
- 运行 `python best_practices/code_finder.py "目录"`
- 运行 `python best_practices/code_finder.py "SEQ"`
- 运行 `python best_practices/code_finder.py --list`
- 验证输出信息是否正确、完整、有用
- （不需要写测试代码，手动验证即可）

### 第二阶段：决策树和反思检查点

**Step 4: 修改 generate_formatter_code.md - 添加决策树（方案A）**
- 位置：在"工作流程"部分，"生成代码"小节之前
- 内容：
  - 代码实现决策流程图
  - Step 1: 识别需求类型
  - Step 2: 查找现成实现（⚠️ 强制步骤）
    - 必须运行 code_finder.py
  - Step 3: 决定实现策略（根据复用度）
  - Step 4: 实现代码
  - Step 5: 自我检查

**Step 5: 修改 generate_formatter_code.md - 添加反思检查点（方案B）**
- 位置：在"执行流程"部分的每个主要阶段后
- 内容：
  - 每个功能模块实现后，增加"🔍 反思检查点"
  - 强制回答的问题：
    - 是否运行了 code_finder.py？
    - 工具推荐的方法是否已复制？
    - 如果没有使用，原因是什么？
  - 关键功能检查：
    - SEQ字段 vs 硬编码
    - OMML vs 纯文本
    - PAGEREF vs 硬编码页码
    - 超链接颜色是否黑色

### 第三阶段：扩展和优化

**Step 6: 扩展 FEATURE_DATABASE**
- 添加更多功能模块：
  - 三线表
  - 页码分节
  - 表头跨页重复
  - 其他边界情况

**Step 7: 优化提示词**
- 根据实际使用情况调整措辞
- 确保强制要求足够明确
- 检查文档长度是否合理

---

## 关键原则

### 工具设计原则
1. **简洁优先**：输出信息简洁但足够，不过度详细
2. **精确定位**：提供精确行号，让AI直接读取
3. **依赖透明**：明确标记依赖关系，避免遗漏
4. **易于使用**：命令简单，查询自然

### 提示词修改原则
1. **保持兼容**：不破坏现有流程
2. **强制引导**：用明确标记（⚠️）强制AI使用工具
3. **反复检查**：在关键节点设置反思检查点
4. **示例丰富**：提供足够的使用示例

### 验证原则
1. **实际运行**：每个功能都要手动运行验证
2. **信息准确**：行号、方法名必须准确
3. **输出可用**：AI能直接根据输出找到代码

---

## 预期效果

### 短期效果
- AI在实现功能前会主动运行 code_finder.py
- AI能快速定位到需要的参考代码
- 减少AI"自己重写"的情况

### 长期效果
- 代码质量提升（复用经过验证的实现）
- 生成速度提升（减少重复思考）
- 错误率降低（避免常见错误）

---

## 注意事项

1. **行号维护**：每次修改reference文件后，需要更新FEATURE_DATABASE中的行号
2. **渐进改进**：先实现核心功能，根据效果逐步扩展
3. **文档同步**：工具和提示词要保持一致
4. **反馈循环**：根据实际使用情况持续优化

---

## 当前状态

- [ ] Step 1: 创建 code_finder.py
- [ ] Step 2: 添加快速索引（方案D）
- [ ] Step 3: 验证工具功能
- [ ] Step 4: 添加决策树（方案A）
- [ ] Step 5: 添加反思检查点（方案B）
- [ ] Step 6: 扩展功能模块
- [ ] Step 7: 优化提示词

---

最后更新：2025-11-22
